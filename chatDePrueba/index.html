<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="/assets/favrobot.ico" type="image/x-icon"/>
  <title>Panel de Control - Asistente API</title>

  <style>
    :root{
      --primary-color:#001440;      
      --primary-dark:#213b75;       
      --info-color:#2196F3;         
      --danger-color:#dc3545;       
      --danger-dark:#c82333;        
      --background-light:#f5f9ff;   
      --panel-bg:#ffffff;           
      --text-color:#1f2d50;         
    }


    html,body{height:100%;} 
    body{
      margin:0;
      font-family:'Segoe UI',sans-serif;
      background:linear-gradient(180deg,#f4f7fb,#e9edf5);
    }

    /*Dise√±o del boton flotante */
    .chat-launcher{
      position:fixed; 
      right: 40px; 
      bottom:40px;
      width:62px; 
      height:62px; 
      border-radius:50%;
      background:var(--primary-color); 
      color:#fff; 
      font-size:28px;
      display:flex; 
      align-items:center; 
      justify-content:center;
      border:none; 
      cursor:pointer; 
      box-shadow:0 12px 28px rgba(0,0,0,.18);
      transition:transform .12s ease, box-shadow .12s ease, background .18s ease;
    }
    .chat-launcher:hover{ transform:translateY(-1px); background:var(--primary-dark); box-shadow:0 16px 34px rgba(0,0,0,.22); }
    .base-de-entrada{
      text-align: center;
      color: var(--text-color);
      margin-bottom: 80px;
    }

    .chat-panel{
      position:fixed; 
      right:40px; 
      bottom:   116px;
      width:380px; 
      max-width:calc(100vw - 40px);
      height:560px; 
      max-height:calc(100vh - 140px);
      background:#fff; 
      border-radius:18px;
      box-shadow:0 24px 48px rgba(0,0,0,.18);
      border:1px solid #e6ecf3; 
      overflow:hidden; 
      display:none; 
      transform-origin:bottom right;
      transform:scale(.98); 
      opacity:0; 
      transition:transform .16s ease, opacity .16s ease;
    }
    .chat-panel.open{ display:block; transform:scale(1); opacity:1; }

    /* -------------------- ENCABEZADO (estilo tarjeta) -------------------- */
    .chat-header{
      background:linear-gradient(135deg,var(--primary-color),var(--primary-dark));
      color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .chat-title{
      display:flex; gap:10px; align-items:center;
      font-weight:600; letter-spacing:.2px;
    }
    .chat-title .logo{
      width:30px; height:30px; border-radius:50%; background:#fff1; display:flex; align-items:center; justify-content:center; font-size:18px;
      border:1px solid #ffffff33;
    }
    .chat-subtitle{ font-size:12px; opacity:.9; margin-top:2px; }

    .chat-close{
      background:transparent; border:none; color:#fff; font-size:20px; cursor:pointer; padding:6px 8px; border-radius:8px;
    }
    .chat-close:hover{ background:rgba(255,255,255,.12); }

    /* ------------------------ CUERPO DEL CHAT ------------------------ */
    .chat-body{ display:flex; flex-direction:column; height:calc(100% - 58px); background:var(--background-light); }

    /* Cinta de acciones (botones que antes estaban fuera) */
    .action-bar{
      background:#fff; border-bottom:1px solid #eef2f8; padding:8px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;
    }
    .action-bar button{
      border:none; border-radius:8px; padding:8px 10px; font-size:12px; cursor:pointer; color:#fff; font-weight:600;
    }
    .action-bar .primary{ background:var(--primary-color); }
    .action-bar .primary:hover{ background:var(--primary-dark); }
    .action-bar .info{ background:var(--info-color); }
    .action-bar .info:hover{ background:#1976d2; }
    .action-bar .danger{ background:var(--danger-color); }
    .action-bar .danger:hover{ background:var(--danger-dark); }
    .action-bar button:disabled{ background:#c7c9d1; cursor:not-allowed; color:#fff; }

    /* √Årea de mensajes con patr√≥n suave de fondo (opcional) */
    .messages-wrap{
      position:relative; flex:1; padding:12px; overflow:auto; background:
        radial-gradient(transparent 0 8px,rgba(255,255,255,.8) 9px) 0 0/40px 40px,
        linear-gradient(#ffffffcc,#ffffffcc);
    }
    .chat-messages{ min-height:100%; }

    /* Burbujas estilo ejemplo */
    .message{ max-width:78%; margin:10px 0; padding:10px 12px; border-radius:14px; position:relative; box-shadow:0 2px 6px rgba(0,0,0,.06); white-space:pre-wrap; }
    .assistant-message{ background:#fff; margin-right:auto; border:1px solid #eef2f8; }
    .user-message{ background:var(--info-color); color:#fff; margin-left:auto; border:1px solid transparent; }
    .timestamp{ font-size:11px; opacity:.7; margin-top:6px; }

    /* Input bar */
    .chat-input{
      display:flex; gap:10px; align-items:center; background:#fff; padding:10px; border-top:1px solid #eef2f8;
    }
    .chat-input input{
      flex:1; padding:12px 12px; border:1px solid #d8e2f0; border-radius:12px; font-size:14px; outline:none;
    }
    .chat-input input:focus{ border-color:var(--primary-color); }
    .chat-input .send{
      width:44px; height:44px; border-radius:22px; border:none; background:var(--primary-color); color:#fff; font-size:18px; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }
    .chat-input .send:hover{ background:var(--primary-dark); }

    /* Indicador typing */
    .typing{ display:flex; gap:5px; }
    .dot{ width:8px; height:8px; background:#444; border-radius:50%; animation:wave 1.3s linear infinite; }
    .dot:nth-child(2){ animation-delay:-1.1s; } .dot:nth-child(3){ animation-delay:-0.9s; }
    @keyframes wave{ 0%,60%,100%{transform:initial;background:#444;} 30%{transform:translateY(-5px);background:#777;} }

    /* Bloques informativos dentro del chat */
    .assistant-info, .assistants-list, .status-area{
      margin:8px 10px; background:#fff; border:1px solid #e6ecf3; border-radius:10px; padding:10px; display:none;
    }
    .assistants-grid{ display:grid; gap:10px; }
    .assistant-item{ background:#f8f9fc; border:1px solid #e6ecf3; border-radius:8px; padding:10px; }

    /* Peque√±as etiquetas */
    .tag{ display:inline-block; padding:2px 8px; background:#eef2f8; border-radius:999px; font-size:11px; color:#51607a; margin-left:8px; }
  </style>
</head>

<body>
  <!-- ============== BOT√ìN FLOTANTE (LAUNCHER) ü§ñ ============== -->
  <h1 class="base-de-entrada">Este tu asistente virtual</h1>
  <!-- NUEVO: abre/cierra el chat, mantiene tu identidad visual -->
  <button id="chatLauncher" class="chat-launcher" aria-label="Abrir chat">ü§ñ
    <span class="badge" id="launcherBadge"></span>
  </button>

  <!-- ========================== CHAT WIDGET ========================== -->
  <!-- NUEVO: Todo el UI (acciones + chat) vive adentro de este panel -->
  <div id="chatPanel" class="chat-panel" aria-hidden="true">
    <div class="chat-header">
      <div>
        <div class="chat-title">
          <div class="logo">ü§ñ</div>
          <div>
            <div>Asistente</div>
            <div class="chat-subtitle">
              <span>Empresa:</span> <span id="empresaActual">‚Äî</span>
              <span class="tag" id="sesionTag">Sin sesi√≥n</span>
            </div>
          </div>
        </div>
      </div>
      <button id="chatClose" class="chat-close" aria-label="Cerrar">‚úï</button>
    </div>

    <!-- BARRA DE ACCIONES: mantiene TODAS TUS FUNCIONALIDADES -->
    <div class="action-bar">
      <!-- Misma colorimetr√≠a que tu front original -->
      <button id="btnCrear" class="primary" onclick="crearAsistente()">Crear Asistente</button>
      <button id="btnEliminar" class="danger" onclick="eliminarAsistente()" disabled>Eliminar Asistente</button>
      <button id="btnListar" class="info" onclick="listarAsistentes()">Ver Asistentes</button>
      <button id="btnActualizar" class="info" onclick="actualizarDatosEmpresa()">Actualizar Datos</button>
      <button id="btnBorrarTodos" class="danger" onclick="borrarTodosAsistentes()">Borrar Todos</button>
      <!-- Extra: Cerrar sesi√≥n (opcional) -->
      <button id="btnLogout" class="danger" onclick="logout()">Cerrar sesi√≥n</button>
    </div>

    <div class="chat-body">
      <!-- Paneles informativos dentro del widget -->
      <div id="assistantInfo" class="assistant-info">
        <h4 style="margin:0 0 8px 0; color:var(--text-color)">Asistente Activo</h4>
        <pre id="assistantData" style="margin:0; font-size:12px;">Sin datos disponibles</pre>
      </div>

      <div id="listaAsistentes" class="assistants-list">
        <h4 style="margin:0 0 8px 0; color:var(--text-color)">Asistentes Activos</h4>
        <div id="contenidoAsistentes"></div>
      </div>

      <!-- √Årea de mensajes con fondo suave y burbujas -->
      <div class="messages-wrap">
        <div class="chat-messages" id="chatMessages"></div>
      </div>

      <!-- Barra de entrada de texto -->
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Escribe tu mensaje..." onkeypress="handleKeyPress(event)" />
        <button class="send" onclick="enviarMensaje()" title="Enviar">‚û§</button>
      </div>

      <!-- Zona de estados (antes estaba fuera del chat) -->
      <div id="resultado" class="status-area"></div>
    </div>
  </div>

  <script>
    /* ================= ESTADO COMPARTIDO (SE MANTIENE) ================= */
    var assistantData = null;

    /* --------------- UTIL: formatea hora para timestamps --------------- */
    function formatTimestamp(date){
      return date.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
    }

    function handleKeyPress(e){ if(e.key==='Enter'){ enviarMensaje(); } }

    /* ================== NUEVO: Abrir/Cerrar Widget ================== */
    function openChat(){
      const panel=document.getElementById('chatPanel');
      panel.classList.add('open'); panel.setAttribute('aria-hidden','false');
    }
    function closeChat(){
      const panel=document.getElementById('chatPanel');
      panel.classList.remove('open'); panel.setAttribute('aria-hidden','true');
    }

    /* ============== ENDPOINTS/FLUJO: IDENTICOS A TU FRONT ============== */

    async function crearAsistente(){
      const resultado=document.getElementById('resultado');
      const assistantInfo=document.getElementById('assistantInfo');
      resultado.style.display='block';
      resultado.innerHTML='<div class="info" style="padding:10px;border-radius:8px;">Creando asistente...</div>';

      const token=localStorage.getItem('access_token');

      try{
        const resp=await fetch('/assistant_open/openai/setup',{
          method:'POST',
          headers:{ 'Accept':'application/json','Authorization':`Bearer ${token}` }
        });
        const data=await resp.json();

        if(resp.ok){
          assistantData=data;
          localStorage.setItem('assistantData',JSON.stringify(assistantData));
          document.getElementById('assistantData').textContent=JSON.stringify(data,null,2);
          assistantInfo.style.display='block';

          // habilitar/deshabilitar como en tu UI original
          document.getElementById('btnCrear').disabled=true;
          document.getElementById('btnEliminar').disabled=false;

          // feedback
          resultado.innerHTML='<div class="success" style="padding:10px;border-radius:8px;">‚úÖ Asistente creado exitosamente</div>';

          // cargar historial si existe
          await cargarHistorial();

          // etiqueta de sesi√≥n
          document.getElementById('sesionTag').textContent='Sesi√≥n activa';
        }else{
          throw new Error(data.detail || 'Error en la respuesta del servidor');
        }
      }catch(err){
        console.error(err);
        resultado.innerHTML=`<div class="error" style="padding:10px;border-radius:8px;">‚ùå Error: ${err.message}</div>`;
      }
    }

    async function eliminarAsistente(){
      const resultado=document.getElementById('resultado');
      const assistantInfo=document.getElementById('assistantInfo');
      resultado.style.display='block';
      resultado.innerHTML='<div class="info" style="padding:10px;border-radius:8px;">Eliminando asistente...</div>';

      try{
        const resp=await fetch(`/assistant_open/openai/cleanup?assistant_id=${assistantData.assistant_id}&thread_id=${assistantData.thread_id}`,{
          method:'DELETE', headers:{ 'Accept':'application/json' }
        });
        const data=await resp.json();

        if(resp.ok){
          resultado.innerHTML='<div class="success" style="padding:10px;border-radius:8px;">‚úÖ Asistente eliminado exitosamente</div>';
          assistantData=null;
          assistantInfo.style.display='none';
          document.getElementById('btnCrear').disabled=false;
          document.getElementById('btnEliminar').disabled=true;
          document.getElementById('chatMessages').innerHTML='';
          document.getElementById('sesionTag').textContent='Sin sesi√≥n';
        }else{
          throw new Error(data.detail || 'Error en la respuesta del servidor');
        }
      }catch(err){
        console.error(err);
        resultado.innerHTML=`<div class="error" style="padding:10px;border-radius:8px;">‚ùå Error: ${err.message}</div>`;
      }
    }

    async function enviarMensaje(){
      const input=document.getElementById('messageInput');
      const msg=input.value.trim();
      if(!msg) return;

      const token=localStorage.getItem('access_token');

      // UI: agregar burbuja del usuario
      const chat=document.getElementById('chatMessages');
      const ts=formatTimestamp(new Date());
      chat.innerHTML+=`
        <div class="message user-message">
          ${msg}
          <div class="timestamp">${ts}</div>
        </div>`;

      // UI: typing indicator
      chat.innerHTML+=`
        <div class="message assistant-message typing-indicator" id="typingIndicator">
          <div class="typing">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          </div>
        </div>`;
      chat.parentElement.scrollTop=chat.parentElement.scrollHeight;

      input.value=''; input.disabled=true;

      try{
        const resp=await fetch('/assistant_open/openai/chat',{
          method:'POST',
          headers:{
            'Content-Type':'application/json','Accept':'application/json','Authorization':`Bearer ${token}`
          },
          body:JSON.stringify({
            message:msg, assistant_id:assistantData.assistant_id, thread_id:assistantData.thread_id
          })
        });
        const data=await resp.json();

        const typing=document.getElementById('typingIndicator');
        if(typing) typing.remove();

        if(resp.ok){
          const tokenStats=data.tokens||{}; const timingStats=data.timing||{};
          const extraInfo=`
            <div class="timestamp">
              üî¢ Tokens ‚Üí Prompt: ${tokenStats.prompt||0}, Completion: ${tokenStats.completion||0}, Total: ${tokenStats.total||0}<br>
              ‚è±Ô∏è Tiempo ‚Üí Total: ${timingStats.total_seconds||0}s | analyze_people_data: ${timingStats.analyze_people_data_seconds||0}s
            </div>`;

          const ts2=formatTimestamp(new Date());
          const formatted=(data.response||'')
            .replace(/\n/g,'<br>')
            .replace(/ {2,}/g, m=>'&nbsp;'.repeat(m.length));

          chat.innerHTML+=`
            <div class="message assistant-message">
              ${formatted}
              ${extraInfo}
              <div class="timestamp">${ts2}</div>
            </div>`;
        }else{
          throw new Error(data.detail || 'Error en la respuesta del servidor');
        }
      }catch(err){
        console.error(err);
        chat.innerHTML+=`<div class="message assistant-message" style="background:#fdecea;border:1px solid #f5c6cb;color:#c62828;">
            ‚ùå Error: ${err.message}
        </div>`;
      }finally{
        input.disabled=false; input.focus();
        chat.parentElement.scrollTop=chat.parentElement.scrollHeight;
      }
    }

    async function cargarHistorial(){
      try{
        if(!assistantData || !assistantData.thread_id) return;
        const resp=await fetch(`/assistant_open/openai/history?thread_id=${assistantData.thread_id}`);
        const data=await resp.json();

        if(resp.ok && data.history){
          const chat=document.getElementById('chatMessages');
          chat.innerHTML='';
          data.history.forEach(m=>{
            const klass=m.role==='user' ? 'user-message' : 'assistant-message';
            chat.innerHTML+=`<div class="message ${klass}">${m.content}</div>`;
          });
          chat.parentElement.scrollTop=chat.parentElement.scrollHeight;
        }
      }catch(err){
        console.error('Error cargando historial:',err);
      }
    }

    async function listarAsistentes(){
      const panel=document.getElementById('listaAsistentes');
      const cont=document.getElementById('contenidoAsistentes');
      panel.style.display='block';
      cont.innerHTML='<div class="info" style="padding:10px;border-radius:8px;">Cargando asistentes...</div>';

      try{
        const resp=await fetch('/assistant_open/openai/assistants',{ headers:{ 'Accept':'application/json' } });
        const data=await resp.json();

        if(resp.ok){
          if((data.assistants||[]).length===0){
            cont.innerHTML='<div class="info" style="padding:10px;border-radius:8px;">No hay asistentes activos</div>';
          }else{
            const list=data.assistants.map(a=>`
              <div class="assistant-item">
                <strong>ID:</strong> ${a.id}<br/>
                <strong>Nombre:</strong> ${a.name}<br/>
                <strong>Creado:</strong> ${new Date(a.created_at*1000).toLocaleString()}
              </div>`).join('');
            cont.innerHTML=`
              <div class="success" style="padding:10px;border-radius:8px;">Total de asistentes: ${data.assistants.length}</div>
              <div class="assistants-grid">${list}</div>`;
          }
        }else{
          throw new Error(data.detail || 'Error en la respuesta del servidor');
        }
      }catch(err){
        console.error(err);
        cont.innerHTML=`<div class="error" style="padding:10px;border-radius:8px;">‚ùå Error: ${err.message}</div>`;
      }
    }

    async function borrarTodosAsistentes(){
      if(!confirm('¬øEst√°s seguro de que quieres borrar todos los asistentes?')) return;

      const resultado=document.getElementById('resultado');
      resultado.style.display='block';
      resultado.innerHTML='<div class="info" style="padding:10px;border-radius:8px;">Eliminando todos los asistentes...</div>';

      try{
        const resp=await fetch('/assistant_open/openai/assistants/all',{ method:'DELETE', headers:{ 'Accept':'application/json' } });
        const data=await resp.json();

        if(resp.ok){
          resultado.innerHTML=`<div class="success" style="padding:10px;border-radius:8px;">‚úÖ Eliminados ${data.deleted_count} de ${data.total_found} asistentes</div>`;
          assistantData=null;
          document.getElementById('assistantInfo').style.display='none';
          document.getElementById('btnCrear').disabled=false;
          document.getElementById('btnEliminar').disabled=true;
          document.getElementById('chatMessages').innerHTML='';
          document.getElementById('sesionTag').textContent='Sin sesi√≥n';

          if(document.getElementById('listaAsistentes').style.display!=='none'){ listarAsistentes(); }
        }else{
          throw new Error(data.detail || 'Error en la respuesta del servidor');
        }
      }catch(err){
        console.error(err);
        resultado.innerHTML=`<div class="error" style="padding:10px;border-radius:8px;">‚ùå Error: ${err.message}</div>`;
      }
    }

    function logout(){
      localStorage.removeItem('access_token');
      localStorage.removeItem('company_name');
      localStorage.removeItem('username');
      localStorage.removeItem('assistantData');
      // No redirigimos ac√° porque est√°s en un widget, pero si quer√©s:
      window.location.href='login.html';
    }

    async function actualizarDatosEmpresa(){
      const resultado=document.getElementById('resultado');
      const company_name=localStorage.getItem('company_name');

      if(!company_name){
        resultado.style.display='block';
        resultado.innerHTML='<div class="error" style="padding:10px;border-radius:8px;">‚ùå No se encontr√≥ el nombre de la empresa</div>';
        return;
      }

      resultado.style.display='block';
      resultado.innerHTML=`<div class="info" style="padding:10px;border-radius:8px;">üîÑ Procesando datos de ${company_name}...</div>`;

      const inicio=performance.now();
      try{
        const resp=await fetch('/s3/process-company',{
          method:'POST',
          headers:{ 'Content-Type':'application/json','Accept':'application/json' },
          body:JSON.stringify({ company_name })
        });
        const fin=performance.now();
        const dur=((fin-inicio)/1000).toFixed(2);
        const data=await resp.json();

        if(resp.ok){
          resultado.innerHTML=`<div class="success" style="padding:10px;border-radius:8px;">‚úÖ Datos actualizados en ${dur} segundos</div>`;
          console.log('Resultado:',data);
        }else{
          throw new Error(data.detail || 'Error al procesar datos');
        }
      }catch(err){
        resultado.innerHTML=`<div class="error" style="padding:10px;border-radius:8px;">‚ùå Error: ${err.message}</div>`;
        console.error(err);
      }
    }

    /* ======================== BOOTSTRAP DE LA UI ======================== */
    document.addEventListener('DOMContentLoaded',()=>{
      // Si no hay sesi√≥n, mandamos a login (igual que antes)
      if(!localStorage.getItem('access_token')){ window.location.href='login.html'; }

      // Empresa en el header
      const empresa=localStorage.getItem('company_name');
      if(empresa){ document.getElementById('empresaActual').textContent=empresa; }

      // Restaurar asistente si existe en localStorage
      const saved=localStorage.getItem('assistantData');
      if(saved){
        assistantData=JSON.parse(saved);
        document.getElementById('assistantData').textContent=JSON.stringify(assistantData,null,2);
        document.getElementById('assistantInfo').style.display='block';
        document.getElementById('btnCrear').disabled=true;
        document.getElementById('btnEliminar').disabled=false;
        document.getElementById('sesionTag').textContent='Sesi√≥n activa';
        cargarHistorial();
      }

      // Launcher abre widget (y lo mantiene autocontenido)
      const launcher=document.getElementById('chatLauncher');
      const closeBtn=document.getElementById('chatClose');

      launcher.addEventListener('click', async ()=>{
        const panel=document.getElementById('chatPanel');
        panel.style.display='block';
        requestAnimationFrame(()=>openChat());

        // Si quer√©s autocrear al abrir (descoment√°):
        // if(!assistantData){ await crearAsistente(); } else { await cargarHistorial(); }
      });

      closeBtn.addEventListener('click', ()=>{
        closeChat();
        setTimeout(()=>{ document.getElementById('chatPanel').style.display='none'; }, 180);
      });
    });
  </script>
</body>
</html>
